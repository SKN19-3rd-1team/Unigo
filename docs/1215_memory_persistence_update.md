# 12/15 Memory Persistence & Interaction Logic Update

## 1. 개요 (Overview)
사용자가 "새로운 세션(새로고침)"을 시작했을 때 이전 정보(이름, 관심사 등)를 기억하지 못하는 문제와, 단순한 대화형 질문("내 이름이 뭐야?")에 대해 AI가 툴 사용을 강제당해 답변하지 못하는 문제를 해결했습니다.

## 2. 주요 변경 사항 (Key Changes)

### 2.1. Chat History Persistence (기억력 강화)
*   **문제점:** 기존 시스템은 `conversation_id`가 변경되면 이전 대화 내용을 컨텍스트에 포함하지 않아, 사용자가 새로고침을 하면 AI가 사용자를 "처음 본 사람"으로 취급했습니다.
*   **수정 파일:** `unigo/unigo_app/views.py` (`chat_api` 함수)
*   **해결 방안:**
    *   새로운 대화가 시작될 때(혹은 모든 대화 턴에서), **사용자의 전체 대화 기록 중 최근 20개 메시지(Global History)**를 조회합니다.
    *   이 '과거 기록'을 현재 대화 컨텍스트(History) 앞단에 주입(Injection)하여, AI가 이전 대화의 맥락을 파악하도록 했습니다.
    *   **Context Window:** Sliding Window 방식을 사용하여, 대화가 길어지면 가장 오래된 기억부터 잊혀지도록 설계했습니다 (최신 10턴 유지).

### 2.2. Direct Response Allowance (대화 유연성 확보)
*   **문제점:** `ReAct` 패턴의 `agent_node`에서 "툴을 호출하지 않으면 오류로 간주"하는 로직이 있어, 사용자가 "안녕", "고마워", "내 이름 기억해?" 같은 툴이 필요 없는 질문을 했을 때 AI가 답변을 못하거나 오류 메시지를 반환했습니다.
*   **수정 파일:** `backend/graph/nodes.py` (`agent_node` 함수)
*   **해결 방안:**
    *   강제 툴 사용(Mandatory Tool Usage) 로직을 제거했습니다.
    *   AI가 툴 호출 없이 텍스트로만 답변(`AIMessage`)하는 경우를 정상적인 응답으로 허용했습니다.
    *   이를 통해 일상 대화나 기억 기반의 답변이 훨씬 자연스러워졌습니다.

## 3. 검증 결과 (Verification)
*   **시나리오 1:** 로그인 -> "내 이름은 유니고야" 입력 -> 새로고침 -> "내 이름은?" 질문 -> "유니고님이시군요!" 답변 확인 (성공)
*   **시나리오 2:** "안녕" 인사 -> 툴 호출 없이 바로 인사 반환 확인 (성공)

## 4. 향후 과제 (Future Work)
*   **Long-term Memory:** 현재는 "최근 20개 메시지"만 기억하므로, 아주 오래된 중요 정보(전공, MBTI 등)를 영구적으로 기억하려면 `UserProfile` 테이블에 별도 필드로 저장하는 '장기 기억 모듈' 도입이 필요합니다.
