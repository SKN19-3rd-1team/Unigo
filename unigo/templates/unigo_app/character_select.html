{% extends "unigo_app/base.html" %}
{% load static %}

{% block title %}Character Select - Unigo{% endblock %}

{% block extra_head %}
<!-- Re-use setting.css or chat.css if needed, but we might need specific styles for the carousel if they were inline or in a specific file. 
     Assuming they were in styles.css or similar. If they were in setting.css, we should include it. -->
<link rel="stylesheet" href="{% static 'css/setting.css' %}">
<style>
    /* Page specific overrides for standalone character page */
    .character-page-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100%;
        max-width: 1200px;
        margin: 0 auto;
        padding: 40px 20px;
        height: 100%;
    }

    .page-title {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 30px;
        color: #333;
    }

    .action-buttons {
        margin-top: 40px;
        display: flex;
        gap: 20px;
    }

    .btn-cancel {
        padding: 12px 30px;
        border-radius: 25px;
        border: 1px solid #ccc;
        background: #fff;
        cursor: pointer;
        font-size: 1rem;
    }

    .btn-save {
        padding: 12px 30px;
        border-radius: 25px;
        border: none;
        background: #000;
        color: #fff;
        cursor: pointer;
        font-size: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="character-page-container">
    <h1 class="page-title">캐릭터 선택</h1>

    <!-- Reuse the Carousel HTML structure -->
    <div class="carousel-scene" style="margin-bottom: 20px;">
        <div class="carousel-3d" id="carousel3d">
            <!-- JS will populate items -->
        </div>
    </div>

    <div class="controls">
        <button class="control-btn" id="prevBtn">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                <polyline points="15 18 9 12 15 6"></polyline>
            </svg>
        </button>

        <div class="character-info-box" id="characterInfo">
            <h2 class="character-info-name" id="characterName">토끼</h2>
            <p class="character-info-desc" id="characterDesc">활발하고 호기심 많은 성격</p>
        </div>

        <button class="control-btn" id="nextBtn">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                <polyline points="9 18 15 12 9 6"></polyline>
            </svg>
        </button>
    </div>

    <div class="action-buttons">
        <button class="btn-cancel" onclick="location.href='{% url 'unigo_app:setting' %}'">취소</button>
        <button class="btn-save" id="saveBtn">선택 및 저장</button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        // ==========================================
        // Character Carousel Logic (Ported)
        // ==========================================
        const characters = [
            { name: '토끼', id: 'rabbit', image: '/static/images/rabbit.png', description: '활발하고 호기심 많은 성격으로 새로운 것을 탐험하는 것을 좋아합니다.' },
            { name: '곰', id: 'bear', image: '/static/images/bear.png', description: '든든하고 믿음직한 성격으로 친구들을 보호하고 배려합니다.' },
            { name: '여우', id: 'fox', image: '/static/images/fox.png', description: '영리하고 재치있는 성격으로 문제 해결 능력이 뛰어납니다.' },
            { name: '고슴도치', id: 'hedgehog', image: '/static/images/hedgehog_ver1.png', description: '조심스럽지만 따뜻한 마음을 가진 성격으로 진정한 친구를 소중히 여깁니다.' },
            { name: '코알라', id: 'koala', image: '/static/images/koala.png', description: '느긋하고 평화로운 성격으로 안정감을 주는 존재입니다.' },
            { name: '수달', id: 'otter', image: '/static/images/otter.png', description: '장난기 많고 사교적인 성격으로 주변을 즐겁게 만듭니다.' },
            { name: '펭귄', id: 'penguin', image: '/static/images/penguin.png', description: '충성스럽고 성실한 성격으로 목표를 향해 꾸준히 나아갑니다.' },
            { name: '너구리', id: 'raccoon', image: '/static/images/raccoon.png', description: '호기심 많고 창의적인 성격으로 독특한 시각을 가지고 있습니다.' },
            { name: '나무늘보', id: 'sloth', image: '/static/images/sloth.png', description: '여유롭고 사려 깊은 성격으로 신중하게 생각하며 행동합니다.' },
            { name: '거북이', id: 'turtle', image: '/static/images/turtle.png', description: '인내심 있고 지혜로운 성격으로 장기적인 목표를 추구합니다.' }
        ];

        let currentIndex = 0;
        const totalItems = characters.length;
        const theta = 360 / totalItems;
        const radius = 400; // Keep consistent with setting.css

        initCarousel();

        function initCarousel() {
            const carousel = document.getElementById('carousel3d');
            carousel.innerHTML = '';

            characters.forEach((character, index) => {
                const item = document.createElement('div');
                item.className = `carousel-item ${index === 0 ? 'active' : ''}`;
                item.innerHTML = `<img src="${character.image}" alt="${character.name}" class="character-image">`;

                const angle = theta * index;
                item.style.transform = `rotateY(${angle}deg) translateZ(${radius}px)`;

                item.addEventListener('click', () => {
                    const diff = index - currentIndex;
                    if (diff > totalItems / 2) rotateCarousel(-(totalItems - diff));
                    else if (diff < -totalItems / 2) rotateCarousel(totalItems + diff);
                    else rotateCarousel(diff);
                });

                carousel.appendChild(item);
            });

            loadUserCharacter();
        }

        async function loadUserCharacter() {
            try {
                const response = await fetch('/api/auth/me');
                const data = await response.json();

                if (data.user && data.user.character) {
                    const charId = data.user.character;
                    const idx = characters.findIndex(c => c.id === charId);
                    if (idx !== -1) {
                        currentIndex = idx;
                        rotateCarousel(0);
                    }
                }
            } catch (error) {
                console.error("Failed to load character:", error);
            }
            updateCharacterInfo();
        }

        function rotateCarousel(direction) {
            currentIndex = (currentIndex + direction + totalItems) % totalItems;

            const carousel = document.getElementById('carousel3d');
            const angle = -theta * currentIndex;
            carousel.style.transform = `rotateY(${angle}deg)`;

            const items = document.querySelectorAll('.carousel-item');
            items.forEach((item, index) => {
                item.classList.toggle('active', index === currentIndex);
            });

            updateCharacterInfo();
        }

        function updateCharacterInfo() {
            const character = characters[currentIndex];
            document.getElementById('characterName').textContent = character.name;
            document.getElementById('characterDesc').textContent = character.description;
        }

        document.getElementById('prevBtn').addEventListener('click', () => rotateCarousel(-1));
        document.getElementById('nextBtn').addEventListener('click', () => rotateCarousel(1));

        document.getElementById('saveBtn').addEventListener('click', async () => {
            const character = characters[currentIndex];

            try {
                const response = await fetch('/api/setting/update-character', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ character: character.id })
                });

                if (response.ok) {
                    alert(`${character.name} 캐릭터가 선택되었습니다.`);
                    localStorage.setItem('user_character', character.id);
                    // Redirect back to settings
                    window.location.href = '{% url "unigo_app:setting" %}';
                } else {
                    alert('저장에 실패했습니다.');
                }
            } catch (error) {
                console.error("Error saving character:", error);
                alert('오류가 발생했습니다.');
            }
        });
    });
</script>
{% endblock %}