{% extends "unigo_app/base.html" %}
{% load static %}
{% block title %}Settings - Unigo{% endblock %}

{% block extra_head %}
{% endblock %}

{% block content %}
<div class="setting-container">
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-user-box">
            <div class="sidebar-avatar"></div>
            <div class="sidebar-username">{{ user.username }}</div>
            <div class="sidebar-email">{{ user.email }}</div>
        </div>
        <div class="sidebar-menu-box">
            <div class="sidebar-btn active" data-target="section-account">계정 설정</div>
            <!-- [NEW] 캐릭터 설정 페이지로 이동 -->
            <a href="{% url 'unigo_app:character_select' %}" class="sidebar-btn"
                style="text-decoration:none; color:inherit; display:block;">캐릭터 설정</a>
        </div>
    </aside>

    <!-- Main Panel -->
    <!-- Main Panel -->
    <div class="setting-panel">

        <!-- [SECTION] Account Settings (Existing) -->
        <section id="section-account" class="setting-section">
            <h1 class="setting-title">계정 설정</h1>
            <p class="setting-desc">개인정보 및 보안 설정을 관리합니다.</p>

            <!-- Tabs Navigation -->
            <div class="setting-tabs">
                <div class="tab-btn active" data-tab="nickname">닉네임 변경</div>
                <div class="tab-btn" data-tab="password">비밀번호 변경</div>
            </div>

            <!-- Nickname Tab -->
            <div class="tab-content active" id="tab-nickname">
                <form id="form-nickname" onsubmit="return false;">
                    <div class="form-group">
                        <label class="input-label">새 닉네임</label>
                        <div class="input-row">
                            <input type="text" class="form-input" id="nickname-input" placeholder="새로운 닉네임을 입력하세요">
                            <button type="button" class="btn-secondary" id="btn-check-duplicate">중복 확인</button>
                        </div>
                        <div class="error-msg" id="nickname-error"></div>
                        <div class="success-msg" id="nickname-success">사용 가능한 닉네임입니다.</div>
                    </div>

                    <div class="form-group">
                        <label class="input-label">현재 비밀번호</label>
                        <input type="password" class="form-input" id="nickname-password"
                            placeholder="본인 확인을 위해 비밀번호를 입력해주세요">
                    </div>

                    <button type="submit" class="setting-btn-primary" id="btn-save-nickname">변경 내용 저장</button>
                </form>
            </div>

            <!-- Password Tab -->
            <div class="tab-content" id="tab-password">
                <form id="form-password" onsubmit="return false;">
                    <div class="form-group">
                        <label class="input-label">현재 비밀번호</label>
                        <input type="password" class="form-input" id="current-password" placeholder="현재 비밀번호">
                    </div>

                    <div class="form-group">
                        <label class="input-label">새 비밀번호</label>
                        <div class="input-row">
                            <input type="password" class="form-input" id="new-password" placeholder="새 비밀번호">
                            <button type="button" class="btn-secondary" disabled
                                style="opacity:0; cursor:default">인증</button> <!-- Layout Spacer -->
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="input-label">새 비밀번호 확인</label>
                        <input type="password" class="form-input" id="new-password-confirm"
                            placeholder="새 비밀번호를 다시 입력하세요">
                        <div class="error-msg" id="password-match-error">비밀번호가 일치하지 않습니다.</div>
                    </div>

                    <button type="submit" class="setting-btn-primary" id="btn-save-password">변경 내용 저장</button>
                </form>
            </div>
        </section>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Tab Switching (Account Settings internal tabs)
        const tabs = document.querySelectorAll('.tab-btn');
        const contents = document.querySelectorAll('.tab-content');

        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                // Remove active class from all
                tabs.forEach(t => t.classList.remove('active'));
                contents.forEach(c => c.classList.remove('active'));

                // Add active to clicked
                tab.classList.add('active');
                const target = tab.dataset.tab;
                document.getElementById(`tab-${target}`).classList.add('active');

                // Reset forms when switching tabs? (Optional)
                resetForms();
            });
        });

        function resetForms() {
            document.getElementById('form-nickname').reset();
            document.getElementById('form-password').reset();
            document.querySelectorAll('.error-msg').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.success-msg').forEach(el => el.style.display = 'none');
            isNicknameChecked = false;
        }

        // ==========================================
        // Nickname Change Logic
        // ==========================================
        let isNicknameChecked = false;

        document.getElementById('btn-check-duplicate').addEventListener('click', async () => {
            const username = document.getElementById('nickname-input').value;
            const errorEl = document.getElementById('nickname-error');
            const successEl = document.getElementById('nickname-success');

            errorEl.style.display = 'none';
            successEl.style.display = 'none';
            isNicknameChecked = false;

            if (!username) {
                errorEl.textContent = '닉네임을 입력해주세요.';
                errorEl.style.display = 'block';
                return;
            }

            try {
                const response = await fetch('/api/setting/check-username', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username })
                });
                const data = await response.json();

                if (data.exists) {
                    errorEl.textContent = data.message;
                    errorEl.style.display = 'block';
                } else {
                    successEl.textContent = data.message;
                    successEl.style.display = 'block';
                    isNicknameChecked = true;
                }
            } catch (error) {
                console.error('Error:', error);
                alert('중복 확인 중 오류가 발생했습니다.');
            }
        });

        document.getElementById('btn-save-nickname').addEventListener('click', async () => {
            const newUsername = document.getElementById('nickname-input').value;
            const password = document.getElementById('nickname-password').value;

            if (!isNicknameChecked) {
                alert('닉네임 중복 확인을 해주세요.');
                return;
            }
            if (!password) {
                alert('비밀번호를 입력해주세요.');
                return;
            }

            try {
                const response = await fetch('/api/setting/change-nickname', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: newUsername, password })
                });
                const data = await response.json();

                if (response.ok) {
                    alert('내용이 변경되었습니다.');
                    location.reload(); // Reload to refresh user state
                } else {
                    alert(data.error || '변경 실패');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('오류가 발생했습니다.');
            }
        });

        // ==========================================
        // Password Change Logic
        // ==========================================
        document.getElementById('btn-save-password').addEventListener('click', async () => {
            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('new-password-confirm').value;
            const matchError = document.getElementById('password-match-error');

            matchError.style.display = 'none';

            if (!currentPassword || !newPassword || !confirmPassword) {
                alert('모든 필드를 입력해주세요.');
                return;
            }

            if (newPassword !== confirmPassword) {
                matchError.style.display = 'block';
                return;
            }

            try {
                const response = await fetch('/api/setting/change-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        current_password: currentPassword,
                        new_password: newPassword
                    })
                });
                const data = await response.json();

                if (response.ok) {
                    alert('내용이 변경되었습니다.');
                    location.reload(); // Reload
                } else {
                    alert(data.error || '변경 실패');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('오류가 발생했습니다.');
            }
        });

        // Sidebar Switching Logic (Account vs others)
        // Since character is now a link, we only handle simple display if needed, 
        // but currently setting page is just account settings + link.
        // We can simplify sidebar logic or remove it if 'active' class on Account is sufficient.
        const sidebarBtns = document.querySelectorAll('.sidebar-btn');
        // Simple logic to keep styles if clicked (though link redirects)
        sidebarBtns.forEach(btn => {
            btn.addEventListener('click', (e) => {
                // If it's a link, let it navigate.
                // If it's a div (like Account), handle tab switch if we had multiple single-page sections.
                if (btn.tagName === 'DIV') {
                    // Logic for account section (already visible by default)
                }
            });
        });
    });
</script>
{% endblock %}